---
title: '關於上傳檔案'
description: '在前端如何上傳檔案'
date: '2023-12-12'
category: 'Web'
tags:
  - Web
  - 檔案處理
---

# 在 Vue 當中上傳檔案的方法

## HTML 表單上傳

- 創建 Form 表單
- method 設定為`post`
- 指定編碼格式：`enctype="multipart/form-data"`

```vue
<script setup>
const getFile = (e) => {
  console.log(e.target.files[0])
}
</script>

<template>
  <div>
    <form action="/upload" method="post" enctype="multipart/form-data">
      選擇檔案：<input type="file" name="file" @change="getFile" />
      <input type="submit" value="上傳檔案" />
    </form>
  </div>
</template>
```

- 因為只有上傳一個檔案，獲取`files`陣列中的第一筆
- 上傳圖片後，可以在`console.log`中看到一個`File`物件
- **name: 檔案名稱**
- **size: 檔案大小**
- **type: 檔案類型**
  ![file-img](/images/notes/file.png)

## 預覽上傳的圖片

#### 方法 1

1. 使用`FileReader`來解析上傳的`File`物件
2. 使用`readAsDataURL`方法，轉換成 URL(base64 編碼)的字串
3. 使用`onload`方法，在檔案轉換完成後觸發 callback function，結果可用`reader.result`取得
4. 賦予值給`previewBase64Url`，放入圖片的 src

```vue
<script setup>
import { ref } from 'vue'
const previewBase64Url = ref('')

const getFile = (e) => {
  console.log(e.target.files[0])
  const file = e.target.files[0]
  const reader = new FileReader()
  if (file) {
    reader.readAsDataURL(file)
  }
  reader.onload = () => {
    console.log(reader.result)
    previewBase64Url.value = reader.result
  }
}
</script>

<template>
  <main class="flex flex-col items-center justify-center">
    <div class="mb-20">
      <form action="/upload" method="post" enctype="multipart/form-data">
        選擇檔案：<input type="file" name="file" @change="getFile" />
        <input type="submit" value="上傳檔案" class="block cursor-pointer font-bold" />
      </form>
    </div>
    <div>
      預覽圖片：
      <img :src="previewBase64Url" alt="preview-img" />
    </div>
  </main>
</template>
```

#### 方法 2

- 使用`URL.createObjectURL`方法創建一個指向該檔案的 URL
- 接受一個`File`物件或是`Blob`物件
- 不再需要時，需使用`revokeObjectURL`釋放記憶體空間

**語法：**

```js
objectURL = URL.createObjectURL(blob)
```

**步驟：**

1. 創建 URL
2. 賦予值給`previewBase64Url`，放入圖片的 src
3. 執行`revokeObjectURL`

- 執行時機：
  1.  當前已有預覽 URL 時
  2.  當圖片加載完成後
  3.  在元件銷毀時

```vue
<script setup>
import { ref, onBeforeUnmount } from 'vue'

const imageUrl = ref('')

const previewImage = (event) => {
  // 先撤銷之前的 URL (如果存在)
  if (imageUrl.value) {
    URL.revokeObjectURL(imageUrl.value)
    imageUrl.value = ''
  }

  const file = event.target.files[0]
  if (file) {
    imageUrl.value = URL.createObjectURL(file)
  }
}

const revokeObjectURL = () => {
  if (imageUrl.value) {
    URL.revokeObjectURL(imageUrl.value)
  }
}

onBeforeUnmount(() => {
  revokeObjectURL()
})
</script>

<template>
  <main class="flex flex-col items-center justify-center">
    <div class="mb-20">
      <input type="file" @change="previewImage" />
    </div>
    <div v-if="imageUrl">
      預覽圖片：
      <img :src="imageUrl" alt="Image preview" @load="revokeObjectURL" />
    </div>
  </main>
</template>
```

## 非同步檔案上傳

使用場景：串接 API，把檔案傳遞給後端

### 方法 1：使用`FormData`來儲存檔案資料

- 用於構造一組鍵值對，代表表單元素和它們的值
- 可以輕鬆的把表單的資料轉換成可以透過 AJAX 傳送到後端的資料形式
- 適合用在表單內有檔案上傳時的情境

**上傳範例：**

- 雖然在 form 表單中沒有指定`enctype`，但在送出 API 請求時，`Content-Type`會自動帶入`multipart/form-data`

```vue
<script setup>
import { reactive } from 'vue'

const formData = reactive({
  name: '',
  image: null
})

const handleFileChange = (event) => {
  formData.image = event.target.files[0]
}

const submitForm = () => {
  const dataToSend = new FormData()

  // 使用append方法，把表單的值加入formdata
  dataToSend.append('name', formData.name)
  if (formData.image) {
    dataToSend.append('image', formData.image)
  }

  fetch('/submit-form', {
    method: 'POST',
    body: dataToSend
  })
    .then((response) => response.json())
    .then((data) => console.log(data))
    .catch((error) => console.error('Error:', error))
}
</script>

<template>
  <form @submit.prevent="submitForm">
    名稱：<input type="text" name="name" v-model="formData.name" /><br />
    圖片：<input type="file" name="image" @change="handleFileChange" /><br />
    <button type="submit">提交</button>
  </form>
</template>
```

### 方法 2：使用 `Base64` 傳輸

- 不推薦用於大型檔案：會使檔案的大小增加約 33%
- 使用`FileReader` 的 `readAsDataURL` 方法將檔案轉換為 Base64 編碼的字符串
- 發出 API 請求的`Content-Type`使用`application/json`

**上傳範例：**

```vue
<template>
  <div class="container">
    <input type="file" @change="handleFileChange" />
    <button @click="uploadFile">上傳檔案</button>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const file = ref(null)

const handleFileChange = (event) => {
  file.value = event.target.files[0]
}

const uploadFile = () => {
  if (file.value) {
    const reader = new FileReader()
    reader.readAsDataURL(file.value)

    // FileReader 完成讀取時，onload 事件被觸發，發送API請求
    reader.onload = async () => {
      try {
        const data = await sendFile(reader.result)
        console.log(data)
      } catch (error) {
        console.error('Error:', error)
      }
    }

    reader.onerror = (error) => {
      console.error('Error: ', error)
    }
  }
}

const sendFile = async (base64String) => {
  try {
    const response = await fetch('/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file: base64String })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    return await response.json()
  } catch (error) {
    console.error('Error sending file:', error)
    throw error
  }
}
</script>
```

## 網頁檔案處理常見格式

### 1. Blob 格式

- `Binary Large Object`的縮寫，代表二進位檔案的資料內容
- 是一個不可變的原始資料
- 在`<input type="file">` 取得的`File`物件也是一種`Blob`物件，繼承了`Blob`的屬性

**特性**

- 可用來下載和上傳大型檔案，例如影片
- 上傳較大的檔案時，可以做到切割，分批上傳

### 2. Base64 格式

- 是一種將二進位資料編碼成 ASCII 字元的編碼方式
- 可以透過文字的方式來呈現二進位資料

**特性**

- Base64 將二進制數據轉換為文本格式，使其能夠被嵌入 JSON、XML 等文本中
- 在不直接支持二進制數據的系統中傳輸圖片或其他文件
- 比原始二進制數據大約 33%
- 將小型圖片直接嵌入到 CSS 或 HTML 中

### 參考圖片

- [圖片來源](https://www.bilibili.com/video/BV1424y1g7ma/?spm_id_from=333.788.recommend_more_video.0&vd_source=e7783c3bc629f610077bf577466b01c5)
  ![file-2](/images/notes/file2.png)

## 參考資料

- [了解 Base64](https://just-func.com/blogs/base64)
- [FileReader](https://developer.mozilla.org/zh-TW/docs/Web/API/FileReader)
- [URL.createObjectURL()](https://developer.mozilla.org/zh-TW/docs/Web/API/URL/createObjectURL_static)
- [使用 Blob 和 File 相關 Web API 即時呈現上傳圖片檔案](https://jiepeng.me/2018/04/17/use-blob-and-file-web-api-create-upload-image-preview-immediately)
- [WebAPIs Form, FormData, 表單取值, AJAX 檔案與資料上傳](https://pjchender.dev/webapis/webapis-form-formdata/)
